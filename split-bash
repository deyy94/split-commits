#!/bin/bash
set -e

BASE_BRANCH="main"
SOURCE_BRANCH="Ejemplo1"
LIMIT=2000

# Validaciones iniciales
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "❌ No estás en un repositorio Git válido."
  exit 1
fi
if ! git rev-parse --verify "$SOURCE_BRANCH" &>/dev/null; then
  echo "❌ La rama '$SOURCE_BRANCH' no existe."
  exit 1
fi

# Punto base y lista de commits (sin merges)
BASE_COMMIT=$(git merge-base "$BASE_BRANCH" "$SOURCE_BRANCH")
COMMITS=($(git rev-list --reverse --no-merges "$BASE_COMMIT".."$SOURCE_BRANCH"))

GROUP=()
GROUP_TOTAL=0
GROUP_NUM=1
PREV_BRANCH=""

for COMMIT in "${COMMITS[@]}"; do
  # Cuenta líneas modificadas
  LINES=$(git show --numstat --format="" "$COMMIT" \
    | awk '{ add += $1; del += $2 } END { print add + del }')
  LINES=${LINES:-0}

  if (( GROUP_TOTAL + LINES > LIMIT )); then
    BRANCH_NAME="${SOURCE_BRANCH}-parte-${GROUP_NUM}"
    echo "🚀 Creando rama $BRANCH_NAME con $GROUP_TOTAL líneas…"

    # Crea rama desde base o desde la anterior
    if [[ -z "$PREV_BRANCH" ]]; then
      git branch "$BRANCH_NAME" "$BASE_COMMIT"
    else
      git branch "$BRANCH_NAME" "$PREV_BRANCH"
    fi
    git checkout "$BRANCH_NAME"

    # Aplica cada commit, saltando los que fallen
    for C in "${GROUP[@]}"; do
      echo "- cherry-pick $C"
      if ! git cherry-pick "$C" &>/dev/null; then
        echo "  ⚠️  No se pudo aplicar $C, omitiendo."
        git cherry-pick --abort &>/dev/null
      fi
    done

    PREV_BRANCH="$BRANCH_NAME"
    GROUP=(); GROUP_TOTAL=0; ((GROUP_NUM++))

    # Volvemos a rama fuente solo para seguir agrupando, sin aplicar nada ahí
    git checkout "$SOURCE_BRANCH" &>/dev/null
  fi

  GROUP+=("$COMMIT")
  GROUP_TOTAL=$((GROUP_TOTAL + LINES))
done

# Último grupo pendiente
if (( ${#GROUP[@]} > 0 )); then
  BRANCH_NAME="${SOURCE_BRANCH}-parte-${GROUP_NUM}"
  echo "🚀 Creando rama $BRANCH_NAME con $GROUP_TOTAL líneas…"

  if [[ -z "$PREV_BRANCH" ]]; then
    git branch "$BRANCH_NAME" "$BASE_COMMIT"
  else
    git branch "$BRANCH_NAME" "$PREV_BRANCH"
  fi
  git checkout "$BRANCH_NAME"

  for C in "${GROUP[@]}"; do
    echo "- cherry-pick $C"
    if ! git cherry-pick "$C" &>/dev/null; then
      echo "  ⚠️  No se pudo aplicar $C, omitiendo."
      git cherry-pick --abort &>/dev/null
    fi
  done
fi

echo "✅ División completada: se crearon $GROUP_NUM ramas desde '$SOURCE_BRANCH'."


# Verifica que estemos en un repo Git
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "âŒ No estÃ¡s en un repositorio Git vÃ¡lido."
  exit 1
fi

# Verifica que exista la rama fuente
if ! git rev-parse --verify "$SOURCE_BRANCH" &>/dev/null; then
  echo "âŒ La rama '$SOURCE_BRANCH' no existe."
  exit 1
fi

# Calcula el commit base
BASE_COMMIT=$(git merge-base "$BASE_BRANCH" "$SOURCE_BRANCH")
echo "ðŸ“ Punto base: $BASE_COMMIT"

# Lista **solo commits no-merges** en orden cronolÃ³gico
COMMITS=($(git rev-list --reverse --no-merges "$BASE_COMMIT".."$SOURCE_BRANCH"))
echo "ðŸ” Commits (sin merges) encontrados: ${#COMMITS[@]}"

GROUP=()
GROUP_TOTAL=0
GROUP_NUM=1
PREV_BRANCH=""

for COMMIT in "${COMMITS[@]}"; do
  # Cuenta lÃ­neas modificadas en este commit
  LINES=$(git show --numstat --format="" "$COMMIT" \
    | awk '{ add += $1; del += $2 } END { print add + del }')
  LINES=${LINES:-0}

  # Si excede el lÃ­mite, crea la rama con el grupo actual
  if (( GROUP_TOTAL + LINES > LIMIT )); then
    BRANCH_NAME="${SOURCE_BRANCH}-parte-${GROUP_NUM}"
    echo "ðŸš€ Creando rama $BRANCH_NAME con $GROUP_TOTAL lÃ­neas..."

    # Crea la rama desde el Ãºltimo punto (base o prev)
    if [[ -z "$PREV_BRANCH" ]]; then
      git branch "$BRANCH_NAME" "$BASE_COMMIT"
    else
      git branch "$BRANCH_NAME" "$PREV_BRANCH"
    fi

    # Aplica los commits acumulados
    git checkout "$BRANCH_NAME"
    for C in "${GROUP[@]}"; do
      git cherry-pick "$C"
    done

    PREV_BRANCH="$BRANCH_NAME"
    GROUP=()
    GROUP_TOTAL=0
    GROUP_NUM=$((GROUP_NUM + 1))
  fi

  GROUP+=("$COMMIT")
  GROUP_TOTAL=$((GROUP_TOTAL + LINES))
done

# Crea la Ãºltima rama si quedan commits
if (( ${#GROUP[@]} > 0 )); then
  BRANCH_NAME="${SOURCE_BRANCH}-parte-${GROUP_NUM}"
  echo "ðŸš€ Creando rama $BRANCH_NAME con $GROUP_TOTAL lÃ­neas..."

  if [[ -z "$PREV_BRANCH" ]]; then
    git branch "$BRANCH_NAME" "$BASE_COMMIT"
  else
    git branch "$BRANCH_NAME" "$PREV_BRANCH"
  fi

  git checkout "$BRANCH_NAME"
  for C in "${GROUP[@]}"; do
    git cherry-pick "$C"
  done
fi

echo "âœ… Proceso completado. Se crearon $GROUP_NUM ramas desde '$SOURCE_BRANCH'."
